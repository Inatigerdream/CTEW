from database.database_schemas import Schemas
from database.dsstox.compounds import Compounds
from database.qsar.compound_descriptor_sets import CompoundDescriptorSets
from database.session import SQLSession
import sys
import click
import pandas as pd

########################################################################################################################

# # Can probably combine below queries into 1

# # blacklisted DTXCIDs
blacklist = ['DTXCID504614', 'DTXCID4035419', 'DTXCID2036118', 'DTXCID7068502', 'DTXCID3076519', 'DTXCID0076679',
             'DTXCID3078896', 'DTXCID6081333', 'DTXCID2083492', 'DTXCID4083632', 'DTXCID8086313', 'DTXCID3086368',
             'DTXCID7086370', 'DTXCID1086750', 'DTXCID0088256', 'DTXCID4088680', 'DTXCID9088681', 'DTXCID9091317',
             'DTXCID6092869', 'DTXCID1096553', 'DTXCID50103737', 'DTXCID40111821', 'DTXCID50113210', 'DTXCID00117389',
             'DTXCID20118934', 'DTXCID60121068', 'DTXCID80132070', 'DTXCID30136866', 'DTXCID10137472', 'DTXCID00142313',
             'DTXCID90145176', 'DTXCID40147882', 'DTXCID20147885', 'DTXCID40161649', 'DTXCID40196552', 'DTXCID40339487',
             'DTXCID00370937', 'DTXCID70370949', 'DTXCID30373395', 'DTXCID90373396', 'DTXCID70373399', 'DTXCID20373400',
             'DTXCID70373410', 'DTXCID50373413', 'DTXCID80373426', 'DTXCID90373477', 'DTXCID70373495', 'DTXCID30373496',
             'DTXCID60373505', 'DTXCID30373512', 'DTXCID90373573', 'DTXCID70373657', 'DTXCID50373695', 'DTXCID60373823',
             'DTXCID80373921', 'DTXCID00374056', 'DTXCID50374389', 'DTXCID00374394', 'DTXCID00382414', 'DTXCID00383865',
             'DTXCID50397710', 'DTXCID90400833', 'DTXCID00404221', 'DTXCID00404882', 'DTXCID00404928', 'DTXCID30405044',
             'DTXCID40406002', 'DTXCID70406959', 'DTXCID00407595', 'DTXCID40410104', 'DTXCID70418279', 'DTXCID40418625',
             'DTXCID10422077', 'DTXCID40426063', 'DTXCID30429942', 'DTXCID70453347', 'DTXCID30453348', 'DTXCID40453859',
             'DTXCID40454629', 'DTXCID30454754', 'DTXCID90454755', 'DTXCID50454756', 'DTXCID30456879', 'DTXCID50457666',
             'DTXCID40458748', 'DTXCID60458902', 'DTXCID80465173', 'DTXCID40480529', 'DTXCID90492773', 'DTXCID00493514',
             'DTXCID40495754', 'DTXCID30496871', 'DTXCID80497757', 'DTXCID90500029', 'DTXCID20503927', 'DTXCID20527062',
             'DTXCID20532297', 'DTXCID40534192', 'DTXCID20534897', 'DTXCID70535814', 'DTXCID30535815', 'DTXCID10535818',
             'DTXCID80535820', 'DTXCID80535825', 'DTXCID00535827', 'DTXCID90535831', 'DTXCID70535834', 'DTXCID30535835',
             'DTXCID10535838', 'DTXCID70535839', 'DTXCID00535847', 'DTXCID20535849', 'DTXCID60535863', 'DTXCID60535868',
             'DTXCID20535869', 'DTXCID50535877', 'DTXCID00535882', 'DTXCID60535883', 'DTXCID20535884', 'DTXCID90535891',
             'DTXCID50535892', 'DTXCID60535904', 'DTXCID80535906', 'DTXCID40535907', 'DTXCID00535908', 'DTXCID60535909',
             'DTXCID70535910', 'DTXCID30535911', 'DTXCID90535912', 'DTXCID50535913', 'DTXCID10535914', 'DTXCID70535915',
             'DTXCID10535919', 'DTXCID70535930', 'DTXCID90535932', 'DTXCID70535935', 'DTXCID00535943', 'DTXCID80535946',
             'DTXCID40535947', 'DTXCID00535948', 'DTXCID60535949', 'DTXCID70535955', 'DTXCID40535962', 'DTXCID10535979',
             'DTXCID20535980', 'DTXCID80535981', 'DTXCID00535983', 'DTXCID80535986', 'DTXCID70535995', 'DTXCID50535998',
             'DTXCID50536001', 'DTXCID30536004', 'DTXCID10536007', 'DTXCID70536008', 'DTXCID20536013', 'DTXCID70536028',
             'DTXCID60536032', 'DTXCID20536033', 'DTXCID90536040', 'DTXCID10536042', 'DTXCID60536052', 'DTXCID60537468',
             'DTXCID50537619', 'DTXCID80537627', 'DTXCID70560500', 'DTXCID80584414', 'DTXCID10584427', 'DTXCID30589277',
             'DTXCID90589278', 'DTXCID40599201', 'DTXCID70613085', 'DTXCID20620300', 'DTXCID60621159', 'DTXCID20626625',
             'DTXCID30643661', 'DTXCID70643665', 'DTXCID80651291', 'DTXCID30652031', 'DTXCID20653850', 'DTXCID80654085',
             'DTXCID70654115', 'DTXCID70654291', 'DTXCID10669667', 'DTXCID40669690', 'DTXCID70671882', 'DTXCID50671901',
             'DTXCID10671922', 'DTXCID20672122', 'DTXCID90672134', 'DTXCID20672309', 'DTXCID70672334', 'DTXCID80672365',
             'DTXCID60672429', 'DTXCID70672571', 'DTXCID00672584', 'DTXCID50672635', 'DTXCID20672788', 'DTXCID20673073',
             'DTXCID20674727', 'DTXCID30675503', 'DTXCID60675677', 'DTXCID70675764', 'DTXCID30675987', 'DTXCID20677056',
             'DTXCID70677081', 'DTXCID10677101', 'DTXCID10677308', 'DTXCID70677329', 'DTXCID40677336', 'DTXCID90677407',
             'DTXCID70677561', 'DTXCID20677697', 'DTXCID30677709', 'DTXCID40693834', 'DTXCID80696208', 'DTXCID10696211',
             'DTXCID50696215', 'DTXCID60696221', 'DTXCID20696222', 'DTXCID10696236', 'DTXCID70696237', 'DTXCID30696238',
             'DTXCID90696239', 'DTXCID80696243', 'DTXCID20696267', 'DTXCID30696273', 'DTXCID50696275', 'DTXCID60696281',
             'DTXCID40696289', 'DTXCID50696290', 'DTXCID40696300', 'DTXCID40696305', 'DTXCID80696309', 'DTXCID70696333',
             'DTXCID70696358', 'DTXCID20696363', 'DTXCID90697322', 'DTXCID70697466', 'DTXCID40697973', 'DTXCID10698139',
             'DTXCID80704079', 'DTXCID60707442', 'DTXCID30707590', 'DTXCID40708710', 'DTXCID90710328', 'DTXCID30711091',
             'DTXCID90711092', 'DTXCID80711425', 'DTXCID30711652', 'DTXCID80711743', 'DTXCID80711925', 'DTXCID80712058',
             'DTXCID90712862', 'DTXCID30713939', 'DTXCID80714133', 'DTXCID40714134', 'DTXCID80714178', 'DTXCID10714742',
             'DTXCID20715548', 'DTXCID50715617', 'DTXCID80715903', 'DTXCID30717033', 'DTXCID50717131', 'DTXCID00717383',
             'DTXCID80717467', 'DTXCID40717468', 'DTXCID50717555', 'DTXCID10717596', 'DTXCID80717826', 'DTXCID80717927',
             'DTXCID10717955', 'DTXCID30718060', 'DTXCID90718122', 'DTXCID60718538', 'DTXCID30718681', 'DTXCID10719813',
             'DTXCID70719814', 'DTXCID60721128', 'DTXCID20721129', 'DTXCID20721689', 'DTXCID30721938', 'DTXCID70722368',
             'DTXCID90722547', 'DTXCID50722548', 'DTXCID30722728', 'DTXCID20722914', 'DTXCID60723980', 'DTXCID30724080',
             'DTXCID00724370', 'DTXCID60724371', 'DTXCID80724792', 'DTXCID80724833', 'DTXCID50725372', 'DTXCID30725759',
             'DTXCID80726110', 'DTXCID10726168', 'DTXCID60726557', 'DTXCID10726885', 'DTXCID50726980', 'DTXCID80727283',
             'DTXCID50727356', 'DTXCID00727381', 'DTXCID60727387', 'DTXCID10727392', 'DTXCID30727692', 'DTXCID80727960',
             'DTXCID00727987', 'DTXCID70728047', 'DTXCID00728050', 'DTXCID00728171', 'DTXCID30728184', 'DTXCID80728215',
             'DTXCID10728288', 'DTXCID70728289', 'DTXCID10728561', 'DTXCID60729821', 'DTXCID30729833', 'DTXCID70729857',
             'DTXCID30729858', 'DTXCID00729880', 'DTXCID40729889', 'DTXCID50729916', 'DTXCID00729921', 'DTXCID80729964',
             'DTXCID40729965', 'DTXCID00729966', 'DTXCID60729967', 'DTXCID80729969', 'DTXCID30729979', 'DTXCID40729980',
             'DTXCID60729987', 'DTXCID30730000', 'DTXCID90730001', 'DTXCID50730002', 'DTXCID70730004', 'DTXCID20730054',
             'DTXCID90730066', 'DTXCID80730090', 'DTXCID30730106', 'DTXCID50730204', 'DTXCID10730361', 'DTXCID30730368',
             'DTXCID90730369', 'DTXCID20730413', 'DTXCID10730427', 'DTXCID70730504', 'DTXCID00730532', 'DTXCID30730904',
             'DTXCID30731239', 'DTXCID80731446', 'DTXCID60731560', 'DTXCID20731561', 'DTXCID30732201', 'DTXCID50733159',
             'DTXCID70733373', 'DTXCID90733471', 'DTXCID00733846', 'DTXCID60733862', 'DTXCID60733887', 'DTXCID90733936',
             'DTXCID00734095', 'DTXCID10734763', 'DTXCID30735631', 'DTXCID10735876', 'DTXCID20735882', 'DTXCID00736094',
             'DTXCID50736100', 'DTXCID80736133', 'DTXCID90737297', 'DTXCID00737485', 'DTXCID20737780', 'DTXCID40738032',
             'DTXCID50738220', 'DTXCID80738319', 'DTXCID20738499', 'DTXCID50738523', 'DTXCID10738524', 'DTXCID90738764',
             'DTXCID90739453', 'DTXCID50739555', 'DTXCID00740070', 'DTXCID90740266', 'DTXCID40740296', 'DTXCID20740491',
             'DTXCID10740506', 'DTXCID90741172', 'DTXCID10741230', 'DTXCID10741811', 'DTXCID80742198', 'DTXCID30742542',
             'DTXCID00743203', 'DTXCID60744014', 'DTXCID80745341', 'DTXCID40745882', 'DTXCID70746983', 'DTXCID10747959',
             'DTXCID00748238', 'DTXCID00748975', 'DTXCID20750893', 'DTXCID70753410', 'DTXCID30753411', 'DTXCID90753412',
             'DTXCID50753413', 'DTXCID10753414', 'DTXCID70753415', 'DTXCID10753792', 'DTXCID90753932', 'DTXCID90754621',
             'DTXCID50754622', 'DTXCID30755490', 'DTXCID30755516', 'DTXCID30755955', 'DTXCID30759392', 'DTXCID90759393',
             'DTXCID50759394', 'DTXCID10759395', 'DTXCID10761493', 'DTXCID80761889', 'DTXCID50763572', 'DTXCID20764490',
             'DTXCID80764491', 'DTXCID70765235', 'DTXCID80765600', 'DTXCID10766342', 'DTXCID30766344', 'DTXCID50766821',
             'DTXCID10766822', 'DTXCID80767568', 'DTXCID70770142', 'DTXCID10770484', 'DTXCID70770485', 'DTXCID00771364',
             'DTXCID20771422', 'DTXCID20772075', 'DTXCID50772962', 'DTXCID10773455', 'DTXCID50773813', 'DTXCID30773871',
             'DTXCID90773938', 'DTXCID00775680', 'DTXCID90776585', 'DTXCID80776938', 'DTXCID90777315', 'DTXCID30777334',
             'DTXCID40777527', 'DTXCID10777736', 'DTXCID00777760', 'DTXCID90777870', 'DTXCID10778440', 'DTXCID80783384',
             'DTXCID70784224', 'DTXCID70784805', 'DTXCID60784910', 'DTXCID20784911', 'DTXCID40785324', 'DTXCID00785325',
             'DTXCID60786797', 'DTXCID80797446', 'DTXCID40800329', 'DTXCID80800545', 'DTXCID40800783', 'DTXCID50800956',
             'DTXCID30800959', 'DTXCID80801037', 'DTXCID70801541', 'DTXCID10801626', 'DTXCID10801888', 'DTXCID70801889',
             'DTXCID30802716', 'DTXCID00802920', 'DTXCID90803380', 'DTXCID40804105', 'DTXCID60804324', 'DTXCID60804344',
             'DTXCID20804345', 'DTXCID80804346', 'DTXCID10804410', 'DTXCID60804501', 'DTXCID50805123', 'DTXCID40805399',
             'DTXCID20805817', 'DTXCID40805834', 'DTXCID80805994', 'DTXCID90806179', 'DTXCID70808459', 'DTXCID60808680',
             'DTXCID80819955', 'DTXCID50820250', 'DTXCID30820258', 'DTXCID00820265', 'DTXCID60820266', 'DTXCID20820282',
             'DTXCID80820283', 'DTXCID30820753', 'DTXCID40848281', 'DTXCID30911195', 'DTXCID50918449',
             'DTXCID201012000', 'DTXCID301020541', 'DTXCID801021613', 'DTXCID601021829', 'DTXCID901021830',
             'DTXCID501024082', 'DTXCID401024360', 'DTXCID00717383']


# # TAKES A LIST OF IDS, QUERIES THE DATABASE FOR TOXPRINTS TO SEE IF THEY EXIST
# # Start from DTXCID

def check(f):
    mysession = SQLSession(Schemas.qsar_schema).get_session()

# # # CHECKS FOR DTXCID IN DSSTOX.COMPOUNDS # # #
    query = mysession.query(Compounds.id, Compounds.dsstox_compound_id)\
        .filter(Compounds.dsstox_compound_id.notin_(blacklist))
    df = pd.DataFrame(list(query))
    df1 = [int(x) for x in df.iloc[:, 0]]

# # # CHECKS FOR ID AND TOXPRINTS IN QSAR.COMPOUND_DESCRIPTOR_SETS # # #
# # # MAKE A LIST OF THE DSSTOX.COMPOUNDS.ID THAT DON'T HAVE SPECIAL TOXPRINTS # # #
    query2 = mysession.query(CompoundDescriptorSets.efk_dsstox_compound_id,
                             CompoundDescriptorSets.descriptor_string_tsv,
                             CompoundDescriptorSets.fk_descriptor_set_id) \
        .filter(CompoundDescriptorSets.fk_descriptor_set_id == '1448')
    df2 = pd.DataFrame(list(query2))

    for index, row in df2.iterrows():
        if row[0] in df1:
            df1.remove(row[0])

    # # # GET THE DTXCIDS FOR THE ENTRIES MISSING TOXPRINTS # # #
    # query3 = mysession.query(Compounds.id, Compounds.dsstox_compound_id).filter(Compounds.id.in_(df1))

    df1 = pd.DataFrame(df1)
    df1.columns = ['id']
    df3 = pd.merge(df1, df, on='id', how='inner')

    mysession.close()

# # # IF QSAR.COMPOUND_DESCRIPTOR_SETS IS MISSING EITHER THEN GENERATE TOXPRINTS FOR THIS COMPOUND # # #
    if df3.empty and f is False:
        click.secho('SQL query is empty: All toxprints available or no DTXCIDs', fg='red', bold=True)
        sys.exit(0)

    elif df3.empty and f is True:
        return( [] ,list(df.iloc[:,1]))

    else:
        return list(df3.iloc[:, 1]), list(df.iloc[:,1])


########################################################################################################################
########################################################################################################################

# # TEST #
#
if __name__=='__main__':
    print(check(True))

# if __name__=='__main__':
#     print(check(False))

########################################################################################################################
